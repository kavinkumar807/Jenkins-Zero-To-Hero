pipeline {
  agent none

  stages {
    stage('Back-end Build & Test') {
      agent {
        docker { image 'maven:3.8.1-adoptopenjdk-11' }
      }
      when {
        changeRequest()        // run only for PR builds
      }
      steps {
        script {
          echo "Back-end: building PR #${env.CHANGE_ID} on branch ${env.CHANGE_BRANCH}"
        }
        sh 'java -version'
      }
    }

    stage('Front-end Build & Test') {
      agent {
        docker { image 'node:16-alpine' }
      }
      when {
        changeRequest()        // run only for PR builds
      }
      steps {
        script {
          echo "Front-end: building PR #${env.CHANGE_ID} on branch ${env.CHANGE_BRANCH}"
        }
        sh 'npm ci'
        sh 'npm test'
      }
    }

    stage('Build on main (post-merge)') {
      agent {
        docker { image 'maven:3.8.1-adoptopenjdk-11' }
      }
      when {
        allOf {
          branch 'main'
          not { changeRequest() }
        }
      }
      steps {
        script {
          echo "Building main branch after merge / push"
        }
        sh 'java -version'
      }
    }

    stage('Deploy to Prod (or target)') {
      agent {
        docker { image 'alpine:latest' }
      }
      when {
        allOf {
          branch 'main'
          not { changeRequest() }
        }
      }
      steps {
        script {
          echo "Deploying from main branch"
        }
        // your deploy commands, e.g.:
        // sh './deploy.sh'
      }
    }
  }

  post {
    always {
      script {
        if (env.CHANGE_ID) {
          echo "Finished PR build for #${env.CHANGE_ID}"
        } else {
          echo "Finished build on branch ${env.BRANCH_NAME}"
        }
      }
    }
  }
}
