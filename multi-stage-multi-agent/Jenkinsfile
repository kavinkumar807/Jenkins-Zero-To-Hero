pipeline {
  agent none

  stages {
    stage('Back-end Build & Test') {
      agent {
        docker { image 'maven:3.8.1-adoptopenjdk-11' }
      }
      when {
        changeRequest()
      }
      steps {
        script {
          echo "Back-end build triggered by Pull Request #${env.CHANGE_ID}"
        }
        sh 'mvn clean verify'
      }
    }

    stage('Front-end Build & Test') {
      agent {
        docker { image 'node:16-alpine' }
      }
      when {
        changeRequest()
      }
      steps {
        script {
          echo "Front-end build triggered by Pull Request #${env.CHANGE_ID}"
        }
        sh 'npm ci'
        sh 'npm test'
      }
    }

    stage('Deploy') {
      agent {
        docker { image 'alpine:latest' }
      }
      when {
        allOf {
          branch 'main'
          not { changeRequest() }
        }
      }
      steps {
        echo "Deploying code after merge / push on main"
        // your deploy commands here
      }
    }
  }

  post {
    always {
      echo "Pipeline done. Branch: ${env.BRANCH_NAME}, PR: ${env.CHANGE_ID}"
    }
  }
}
